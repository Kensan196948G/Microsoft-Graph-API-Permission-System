# Microsoft Graph API パーミッション管理システム

Microsoft Graph APIを使用して、ユーザーやグループに対するAPIパーミッション（AppRole）を効率的に付与および削除するためのPowerShellスクリプトです。単一ユーザー、複数ユーザー、セキュリティグループなど、様々な対象に対して操作可能です。

> **最新更新情報（2025/03/18）**：スクリプトの構文エラーを修正し、安定性を向上させました。基本機能を正しく動作するように再構築しています。

## 🎯 特徴

- ✅ Microsoft Graph モジュールの自動インストール & ログイン処理  
- ✅ グローバル管理者であることを自動確認  
- ✅ 対象のシステム（OneDrive / Teams / EntraID / Exchange）を選択可能
- ✅ 対象の API パーミッション ID（App Role ID）を自動取得・表示
- ✅ **各システムに最適なパーミッションセットを一括付与**（NEW!）
- ✅ 複数のユーザー選択方法（検索、グループ、CSVインポート）
- ✅ 一括処理による複数ユーザーへの権限付与/削除
- ✅ 詳細なエラーハンドリングと実況ログ機能
- ✅ 時刻付きログファイル名（MicrosoftGraphLog.yyyyMMddHHmmss.txt）

## 📋 必要要件

- Windows PowerShell 5.1以上またはPowerShell Core 7.0以上
- 管理者権限を持つアカウント（グローバル管理者権限が必要）
- インターネット接続（Microsoft Graph APIに接続するため）
- Microsoft Graph PowerShellモジュール（スクリプトが自動的にインストールします）

## 🔧 インストール方法

1. このリポジトリをクローンまたはダウンロード
2. `Microsoft Graph API パーミッション付与削除スクリプト.ps1` ファイルをご利用のマシンに保存

## 🚀 使用方法

1. スクリプトファイルを**右クリック**
2. 表示されたメニューから「**PowerShellで実行**」を**左クリック**
3. 必要に応じて管理者権限を許可

または、PowerShellコンソールから直接実行:
   ```powershell
   .\Microsoft Graph API パーミッション付与削除スクリプト.ps1
   ```

## 📋 詳細な操作手順

スクリプトを実行すると、以下の手順でパーミッション管理を行います：

1. **初期セットアップ**
   - 管理者権限の確認（非管理者の場合は警告が表示されます）
   - Microsoft Graph モジュールの確認とインストール
   - Microsoft Graph APIへのログイン画面が表示されます
   - ブラウザが開き、管理者アカウントでログインしてください

2. **システム選択**
   - 「対象のシステムを選択」メニューが表示されます
   - 数字キーで選択：
     1. OneDrive for Business
     2. Microsoft Teams
     3. Microsoft EntraID
     4. Exchange Online
   - 終了する場合は「Q」を押してください

3. **アクション選択**
   - 「実行するアクション」メニューが表示されます
   - 数字キーで選択：
     1. **最適なパーミッションセットを一括付与**
     2. 個別にパーミッションを付与
     3. パーミッションを削除
     4. 現在のパーミッション割り当てを表示

4. **パーミッション選択**
   - 利用可能なAPIパーミッションが一覧表示されます
   - 各パーミッションのID、説明、値が表示されます
   - 数字キーで目的のパーミッションを選択してください
   
5. **パーミッションを付与/削除する一般ユーザーの選択**
   - 「ユーザー選択方法」メニューが表示されます
   - 数字キーで選択：
     1. 個別ユーザーを検索
     2. セキュリティグループからユーザーを選択
     3. CSVファイルからユーザーをインポート

6. **ユーザーの選択（選択方法に応じて）**
   - **個別ユーザー検索の場合**：
     - ユーザー名、メールアドレス、またはSAMACCOUNTNAMEの一部を入力
     - 検索結果から対象ユーザーを選択（複数選択可能）
     - 複数選択の場合は、番号をカンマ区切りで入力
     - 選択完了後は「done」と入力

   - **セキュリティグループ選択の場合**：
     - 利用可能なセキュリティグループが表示されます
     - グループを選択すると、そのメンバーが自動的に選択されます
     - 選択されたユーザー一覧を確認し、承認するかどうかを選択

   - **CSVインポートの場合**：
     - CSVファイルのパスを入力
     - 選択されたユーザー一覧を確認し、承認するかどうかを選択

7. **処理の実行と確認**
   - 実行前に操作内容の概要が表示され、確認を求められます
   - 処理実行中は進捗状況がリアルタイムで表示されます
   - 処理完了後、詳細な結果サマリーが表示されます
     - 成功件数、スキップ件数、失敗件数、合計件数
     - 処理中の詳細なエラー情報（発生した場合）
     - 操作サマリー（システム、パーミッション、アクションなど）
   - 実況ログファイルの保存場所が表示されます
   - 全ての詳細情報とエラーはログファイルに記録されます

## 📊 システム別最適パーミッションセット

各ITサービス・システム向けに最適化されたパーミッションセットを定義しています：

### 1. OneDrive for Business
- **User.Read.All** - ユーザー情報へのアクセス
- **Directory.Read.All** - 組織構造情報へのアクセス 
- **Files.ReadWrite.All** - OneDriveファイルの読み書き

### 2. Microsoft Teams
- **User.Read.All** - ユーザー情報へのアクセス
- **Directory.Read.All** - 組織構造情報へのアクセス
- **Team.ReadWrite.All** - Teams管理
- **Channel.ReadWrite.All** - チャネル管理
- **Chat.ReadWrite.All** - チャット管理

### 3. Microsoft EntraID
- **User.Read.All** - ユーザー情報へのアクセス
- **Directory.ReadWrite.All** - ディレクトリデータの管理
- **Group.ReadWrite.All** - グループ管理
- **RoleManagement.ReadWrite.Directory** - ロール管理

### 4. Exchange Online
- **User.Read.All** - ユーザー情報へのアクセス
- **Directory.Read.All** - 組織構造情報へのアクセス
- **Mail.ReadWrite.All** - メール管理
- **MailboxSettings.ReadWrite** - メールボックス設定管理
- **Calendars.ReadWrite.All** - カレンダー管理

## ⚙️ 主な機能

### 1. 一括パーミッションセット付与

- **最適なパーミッションセットを一括付与**: システムに応じた最適なパーミッションのセットを一度の操作で付与
- **パーミッション自動マッチング**: システムごとに必要なパーミッションを自動的に検出して適用
- **詳細な適用レポート**: 各パーミッションごとの適用結果を詳細に記録・表示
- **ユーザーごとのサマリー**: ユーザー単位での付与成功/失敗/スキップを集計
- **柔軟な続行オプション**: 一部のパーミッションが見つからない場合でも続行可能

### 2. ユーザー選択のベストプラクティス

- **3つの選択方法**:
  - 個別ユーザー検索（名前/メールアドレス/ログイン名"SAMACCOUNTNAME"で検索可能）
  - セキュリティグループからの一括選択（既存のグループ構造を活用）
  - CSVファイルからの一括インポート（大規模環境での運用に最適）
- **複数ユーザー選択**: 一度に複数ユーザーに対してパーミッション操作が可能
- **選択前の確認**: 操作前に対象ユーザーをリスト表示して確認

### 3. 詳細なエラーハンドリング

- **階層的な例外処理**: すべての操作に対して詳細な例外処理を実装
- **個別のエラー追跡**: 複数ユーザー処理時に各ユーザーごとのエラーを追跡
- **エラーサマリー**: 処理結果を成功/失敗でカウントし、詳細なエラー情報を表示
- **バッチ処理の継続性**: 一部ユーザーの処理が失敗しても残りのユーザー処理は継続

### 4. 拡張ログ機能

- 全ての操作を時刻付きでログファイルに詳細に記録
- 時刻付きログファイル名（MicrosoftGraphLog.yyyyMMddHHmmss.txt）で自動生成
- 複数の詳細度レベル（INFO, WARNING, ERROR, SUCCESS, DEBUG, VERBOSE）でログを記録
- 詳細なエラーログ（エラーメッセージ、スタックトレース、システム情報など）
- ユーザー別の処理結果の詳細ログ（成功/失敗/スキップ）
- API呼び出し時間の計測と記録によるパフォーマンス分析
- 処理開始/終了時刻と総実行時間の記録
- 実行サマリーの自動生成（成功/失敗/スキップカウント、エラー数など）

## 📋 CSVファイル形式（インポート用）

CSVファイルを使用してユーザーをインポートする場合、以下の形式が必要です：

```csv
UserPrincipalName
user1@example.com
user2@example.com
user3@example.com
```

- ヘッダー行には必ず「UserPrincipalName」を含めてください
- 各行にユーザーのUPNを1つずつ記載します

## ⚠️ 注意事項

- このスクリプトを実行するには、グローバル管理者権限が必要です
- 大量のユーザーに対して操作を行う場合は、APIレート制限に注意してください
- 本番環境で使用する前に、テスト環境でスクリプトの動作を確認することをお勧めします
- 最新バージョン（2025/03/18更新）は構文エラーを修正し、安定性を向上させています

## 📊 エラー対応と診断

エラーが発生した場合は、自動生成された詳細ログファイル（MicrosoftGraphLog.yyyyMMddHHmmss.txt）を確認してください。拡張されたエラーハンドリング機能により、以下の詳細情報が記録されます：

- **詳細なエラー情報**: エラーメッセージ、エラーカテゴリ、エラーID、発生箇所
- **スタックトレース**: エラーの発生経路を示す詳細な情報
- **システム情報**: PowerShellバージョン、OS情報、実行ユーザーなど
- **処理結果サマリー**: 成功/スキップ/失敗カウントと総合結果ステータス
- **API呼び出し時間**: 各API操作にかかった時間（ミリ秒単位）

一般的なエラーとその対応方法：

- **認証エラー**: Microsoft Graphへの接続に失敗した場合は、管理者アカウントで再ログインしてください
- **パーミッションエラー**: 必要な権限がない場合は、グローバル管理者権限を持つアカウントで実行してください
- **ユーザー検索エラー**: ユーザー名やメールアドレスを正確に入力しているか確認してください
- **CSVインポートエラー**: CSVファイルの形式が正しいか、「UserPrincipalName」列が存在するか確認してください
- **API制限エラー**: 大量の処理を行った場合、API制限に達する可能性があります。時間をおいて再試行してください
- **構文エラー**: スクリプトの実行中に構文エラーが発生した場合は、最新バージョンを使用しているか確認してください

## 📜 ライセンス

このスクリプトは自由に利用・改変していただけます。ご利用は自己責任でお願いします。
